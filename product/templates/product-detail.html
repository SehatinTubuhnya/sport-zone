{% extends 'base.html' %}

{% block meta %}
<title>Detail Produk | SportZone</title>
{% endblock meta %}

{% block content %}
<main class="container mx-auto p-4 mt-4">
  <div id="product-detail-container" class="grid grid-cols-1 lg:grid-cols-5 gap-8">
    
    <div class="lg:col-span-2 animate-pulse">
      <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200">
        <div class="w-full h-[400px] bg-gray-200 rounded-lg"></div>
      </div>
    </div>
    
    <div class="lg:col-span-3 animate-pulse space-y-5">
      <div class="h-10 bg-gray-200 rounded w-full"></div> <div class="h-8 bg-gray-200 rounded w-1/2"></div> <div class="h-6 bg-gray-200 rounded w-1/4"></div> <div class="pt-4 border-t border-gray-200">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gray-200 rounded-full"></div>
          <div class="flex-1 space-y-2">
            <div class="h-4 bg-gray-200 rounded w-1/4"></div>
            <div class="h-4 bg-gray-200 rounded w-1/2"></div>
          </div>
        </div>
      </div>
      
      <div class="pt-4 border-t border-gray-200">
        <div class="h-12 bg-gray-200 rounded-md w-full"></div>
      </div>
    </div>

    <div class="lg:col-span-5 animate-pulse space-y-2">
      <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
        <div class="h-6 bg-gray-200 rounded w-1/3 mb-4"></div>
        <div class="h-4 bg-gray-200 rounded w-full"></div>
        <div class="h-4 bg-gray-200 rounded w-full"></div>
        <div class="h-4 bg-gray-200 rounded w-3/4"></div>
      </div>
    </div>
  </div>
</main>

<div id="product-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
  <div class="bg-white rounded-lg shadow-xl flex flex-col w-full max-w-lg max-h-full">
    <div class="flex justify-between items-center border-b p-4">
      <h3 id="modal-title" class="text-xl font-semibold">Tambah Produk Baru</h3>
      <button id="modal-close-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
    </div>

    <form id="product-form" class="p-6 pt-2 space-y-4 max-h-full overflow-auto">
      <input type="hidden" id="form-product-id" name="product_id">
      
      <div>
        <label for="form-product-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Produk</label>
        <input type="text" id="form-product-name" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
      </div>
      
      <div>
        <label for="form-product-price" class="block text-sm font-medium text-gray-700 mb-1">Harga (Rp)</label>
        <input type="number" id="form-product-price" name="price" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
      </div>
      
      <div>
        <label for="form-product-category" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
        <select id="form-product-category" name="category" required class="w-full px-3 py-2 border border-gray-300 rounded-md bg-white">
          <option value="equipment">Equipment</option>
          <option value="apparel">Apparel</option>
          <option value="ball">Ball</option>
        </select>
      </div>
      
      <div>
        <label for="form-product-thumbnail" class="block text-sm font-medium text-gray-700 mb-1">URL Thumbnail (Opsional)</label>
        <input type="url" id="form-product-thumbnail" name="thumbnail" placeholder="https://..." class="w-full px-3 py-2 border border-gray-300 rounded-md">
      </div>

      <div>
        <label for="form-product-description" class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
        <textarea id="form-product-description" name="description" rows="4" required class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
      </div>

      <div class="flex items-center gap-2">
        <input type="checkbox" id="form-product-featured" name="is_featured" />
        <label for="form-product-featured" class="block text-sm font-medium text-gray-700 mb-1">Featured</label>
      </div>
      
      <div id="form-message" class="text-sm text-red-600 hidden"></div>

      <div class="flex justify-end space-x-3 pt-4 border-t">
        <button type="button" id="modal-cancel-btn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-medium hover:bg-gray-300">
          Batal
        </button>
        <button type="submit" id="form-submit-btn" class="bg-black text-white px-4 py-2 rounded-md font-medium hover:bg-gray-800">
          Simpan
        </button>
      </div>
    </form>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const productPk = "{{ id }}";
  const container = document.getElementById('product-detail-container');

  const formatter = new Intl.NumberFormat('id-ID', {
    style: 'currency',
    currency: 'IDR',
    minimumFractionDigits: 0
  });

  const productModal = document.getElementById('product-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalCloseBtn = document.getElementById('modal-close-btn');
  const modalCancelBtn = document.getElementById('modal-cancel-btn');
  const productForm = document.getElementById('product-form');
  const formProductId = document.getElementById('form-product-id');
  const formMessage = document.getElementById('form-message');
  const formSubmitBtn = document.getElementById('form-submit-btn');

  /**
   * Mengambil data detail produk dari API
   */
  async function fetchProductData(pk) {
    const BASE_DATA_URL = "{% url 'product:api-product-detail' 1234 %}";
    const API_ENDPOINT = BASE_DATA_URL.replace("1234", pk);

    try {
      const response = await fetch(API_ENDPOINT);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const data = await response.json();

      document.querySelector("title").innerText = `${data.name} | SportZone`;

      renderProduct(data);
    } catch (error) {
      console.error("Gagal mengambil data produk:", error);
      renderError("Gagal memuat produk. Silakan coba lagi.");
    }
  }

  /**
   * Merender data produk ke dalam kontainer
   */
  function renderProduct(data) {
    const defaultImage = 'https://placehold.co/600x600/F3F4F6/777777?text=No+Image';
    const imageUrl = data.thumbnail || defaultImage;
    const imageCol = `
      <div class="lg:col-span-2">
        <div class="bg-white p-4 rounded-lg shadow-md border border-gray-200">
          <img src="${imageUrl}" alt="${data.name}" class="w-full h-auto max-h-[500px] object-contain rounded-lg">
        </div>
      </div>
    `;

    const defaultSellerPic = `<svg width="40" height="40" viewBox="0 0 40 40" ...>...</svg>`;
    const sellerPic = data.seller.profile_pic
      ? `<img src="${data.seller.profile_pic}" class="w-10 h-10 rounded-full object-cover border">`
      : defaultSellerPic;

    let buttonsHTML = '';
    if (data.can_manage) {
      buttonsHTML = `
        <div class="pt-4 border-t flex flex-col sm:flex-row gap-3">
          <button id="edit-product-btn" data-id="${data.id}" class="text-center w-full bg-black text-white px-5 py-3 rounded-md font-semibold hover:bg-gray-800">
            Edit Produk
          </button>
          <button id="delete-product-btn" data-id="${data.id}" class="w-full bg-red-600 text-white px-5 py-3 rounded-md font-semibold hover:bg-red-700">
            Hapus Produk
          </button>
        </div>
      `;
    } else {
      buttonsHTML = `
        <div class="pt-4 border-t">
          <button class="w-full bg-black text-white px-5 py-3 rounded-md font-semibold hover:bg-gray-800 transition">
            + Tambah ke Keranjang
          </button>
        </div>
      `;
    }

    const infoCol = `
      <div class="lg:col-span-3">
        <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200 space-y-4">
          
          <h1 class="text-4xl font-bold text-gray-900 break-words">${data.name}</h1>
          <p class="text-3xl font-semibold text-black">${formatter.format(data.price)}</p>
          <span class="inline-block bg-gray-100 text-gray-700 text-sm font-medium px-3 py-1 rounded-full">
            ${data.category_display}
          </span>
          
          <div class="pt-4 border-t">
            <p class="text-sm text-gray-500 mb-1">Penjual</p>
            <a ${data.seller.username === "Toko Resmi" ? "" : `href="${"{% url 'userprofile:profile-page' 'USER_PLACEHOLDER' %}".replace("USER_PLACEHOLDER", data.seller.username)}"`} class="flex items-center gap-3 group">
              ${sellerPic}
              <span class="text-md font-medium text-black ${data.seller.username === "Toko Resmi" ? '' : 'group-hover:underline'}">${data.seller.username}</span>
            </a>
          </div>

          ${buttonsHTML}

        </div>
      </div>
    `;

    const descriptionSection = `
      <div class="lg:col-span-5">
        <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
          <h3 class="text-xl font-semibold text-gray-800 mb-3">Deskripsi Produk</h3>
          <p class="text-gray-600 whitespace-pre-wrap">${data.description}</p>
        </div>
      </div>
    `;

    container.innerHTML = imageCol + infoCol + descriptionSection;
  }

  /**
   * Menampilkan pesan error
   */
  function renderError(message) {
    container.innerHTML = `
      <div class="lg:col-span-5 text-center py-10 bg-white rounded-lg shadow-md border border-red-200">
        <p class="text-red-500">${message}</p>
      </div>
    `;
  }

  /**
   * Menangani aksi hapus produk
   */
  async function handleDeleteProduct(id) {
    const BASE_DELETE_URL = "{% url 'product:api-product-delete' 1234 %}"
    const deleteUrl = BASE_DELETE_URL.replace("1234", id);

    try {
      const response = await fetch(deleteUrl, {
        method: 'POST'
      });

      if (!response.ok) {
        const data = await response.json();
        throw new Error(data.error || 'Gagal menghapus produk.');
      }

      showToast('Produk berhasil dihapus', 'Anda akan dialihkan dalam beberapa saat...', 'success');

      setTimeout(() => {
        window.location.href = "{% url 'product:show_products_list' %}";
      }, 3000);
    } catch (error) {
      console.error('Gagal menghapus:', error);

      showToast("Gagal menghapus", error.message, "error");
    }

    hideSureModal();
  }

  function showModal() {
    formMessage.classList.add('hidden');
    formMessage.textContent = '';
    productModal.classList.remove('hidden');
  }

  function hideModal() {
    productModal.classList.add('hidden');
    productForm.reset();
    formProductId.value = '';
  }

  async function openModalForEdit(productId) {
    productForm.reset();
    modalTitle.textContent = 'Mengedit Produk...';
    formSubmitBtn.disabled = true;
    showModal();

    try {
      const BASE_URL = "{% url 'product:api-product-detail' 1234 %}"
      const response = await fetch(BASE_URL.replace("1234", productId)); 
      if (!response.ok) {
        const errData = await response.json();
        throw new Error(errData.error || 'Gagal memuat data edit');
      }
      const product = await response.json();

      modalTitle.textContent = 'Edit Produk';
      formProductId.value = product.id;
      document.getElementById('form-product-name').value = product.name;
      document.getElementById('form-product-price').value = product.price;
      document.getElementById('form-product-category').value = product.category;
      document.getElementById('form-product-thumbnail').value = product.thumbnail || '';
      document.getElementById('form-product-description').value = product.description;
      
      formSubmitBtn.textContent = 'Update';
      formSubmitBtn.disabled = false;

    } catch (error) {
      console.error('Gagal memuat data edit:', error);
      formMessage.textContent = error.message;
      formMessage.classList.remove('hidden');
      formSubmitBtn.disabled = true;
    }
  }

  async function handleFormSubmit(e) {
    e.preventDefault();
    formSubmitBtn.disabled = true;
    formSubmitBtn.textContent = 'Menyimpan...';
    formMessage.classList.add('hidden');

    const productId = formProductId.value;
    if (!productId) {
      formMessage.textContent = 'ID Produk tidak ditemukan.';
      formMessage.classList.remove('hidden');
      formSubmitBtn.disabled = false;
      return;
    }

    const formData = new FormData(productForm);

    const url = "{% url 'product:api-product-update' 1234 %}".replace("1234", productId);

    try {
      const response = await fetch(url, {
        method: "POST",
        body: formData
      });
      const data = await response.json();
      if (!response.ok) throw new Error(data.error || 'Gagal update.');

      hideModal();
      fetchProductData(productPk); 
    } catch (error) {
      console.error('Gagal submit form:', error);
      formMessage.textContent = error.message;
      formMessage.classList.remove('hidden');
      formSubmitBtn.disabled = false;
      formSubmitBtn.textContent = 'Update';
    }
  }

  container.addEventListener('click', (e) => {
    const deleteBtn = e.target.closest('#delete-product-btn');
    const editBtn = e.target.closest('#edit-product-btn');

    if (deleteBtn) {
      const productId = e.target.dataset.id;

      showSureModal("Produk yang sudah dihapus tidak bisa dipulihkan.", "Hapus", () => handleDeleteProduct(productId));
    } else if (editBtn) {
      e.preventDefault();
      openModalForEdit(editBtn.dataset.id);
    }
  });

  modalCloseBtn.addEventListener('click', hideModal);
  modalCancelBtn.addEventListener('click', hideModal);
  productForm.addEventListener('submit', handleFormSubmit);

  fetchProductData(productPk);

});
</script>
{% endblock content %}
