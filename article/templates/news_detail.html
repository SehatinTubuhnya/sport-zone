{% extends 'base.html' %}

{% block meta %}
<title id="siteTitle"></title>
{% endblock meta %}

{% block content %}
<div class="bg-white w-full min-h-screen">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Loading State -->
         <!-- again, i changed the colour -->
        <div id="loading-state" class="bg-white rounded-lg border border-gray-200 p-12 text-center">
            <svg class="animate-spin h-8 w-8 text-green-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="cyan-500" stroke-width="4"></circle>
                <path class="opacity-75" fill="cyan-500" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <p class="text-gray-600 mt-3">Loading news details...</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
            <div class="w-16 h-16 mx-auto mb-4">
                <div class="text-red-500 text-5xl">⚠️</div>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Failed to load news</h3>
            <p class="text-gray-500">Please try again later.</p>
        </div>

        <!-- Article -->
         <!-- article-content -->
        <article id="article-content" class="bg-white rounded-lg border border-gray-200 overflow-hidden">
            <!-- Header -->
            <div class="p-6 sm:p-8">
                <div class="flex flex row justify-between">
                    <div>
                        <p id="path" class="text-gray-600">Home  >  Artikel  >  </p>
                    </div>
                    <!-- Back Navigation -->
                    <div class="mb-6">
                        <a href="{% url 'article:show_article' %}" class="text-gray-600 hover:text-gray-900 font-medium transition-colors">
                            ← Back to Main menu
                        </a>
                    </div>
                </div>
                <div id="badges-container" class="flex flex-wrap items-center gap-2 mb-4">
                    <!-- Dynamic badges will be inserted here -->
                </div>
                
                <!-- article title -->
                <h1 id="news-title" class="text-3xl sm:text-4xl font-bold text-gray-900 leading-tight mb-2">
                    <!-- Title will be inserted here -->
                </h1>
                
                <!-- article-date -> posted date -->
                <div class="flex flex-wrap items-center text-sm text-gray-500 gap-4 mb-4">
                    <div id="author">

                    </div>
                    <span>  |  </span>
                    <time id="posted-date">
                        <!-- Date will be inserted here -->
                    </time>

                    <span id="news-type">
                    <!-- News will be inserted here -->
                    </span>
                </div>

                <div id="editDeleteBtn">
                    
                </div>
            </div>

            <!-- Featured Image -->
            <div id="featured-image-container" class="px-6 sm:px-8 hidden">
                <img id="featured-image" 
                     src="" 
                     alt="" 
                     class="w-full h-64 sm:h-80 lg:h-96 object-cover rounded-lg">
            </div>

            <!-- Content -->
            <div class="p-6 sm:p-8">
                <div class="prose prose-lg max-w-none">
                    <!-- article-content-text -->
                    <div id="news-content" class="text-gray-700 leading-relaxed whitespace-pre-line text-base sm:text-lg">
                        <!-- Content will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- write comments -->
            <div class="border-t border-gray-200 p-6 sm:p-8 bg-white">
                <div class="font-medium text-gray-900 mb-4">
                    <p class="text-2xl">Komentar</p>
                </div>

                <div class="w-full bg-gray-100 rounded shadow-sm border border-gray-200 mb-6 p-4">
                    <div class="flex flex-row">
                        <img src="https://placehold.co/40x40/E0E0E0/333333?text=Me" class="w-10 h-10 rounded-full mr-4" alt="My Avatar">
                        <div class="w-full">
                            <form id="commentForm">
                                <textarea id="writeComment" rows="3" name="content" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-black focus:border-black" placeholder="Tulis komentar Anda..."></textarea>
                            </form>
                            <button type="button" id="submitComment" form="commentForm" class="mt-2 bg-black text-white px-5 py-2 rounded-md text-sm font-medium hover:bg-gray-800">
                                Kirim
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- posted comments -->
            <div id="commentCards"></div>
        </article>
    </div>
</div>

<script>
// Configuration
const NEWS_ID = "{{ news.id }}";
const NEWS_DETAIL_ENDPOINT = `{% url 'article:show_json_by_id' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', NEWS_ID);
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

window.onload = function() {
    // DOM Elements
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const articleContent = document.getElementById('article-content');
    const newsContent = document.getElementById('news-content');
    const badgesContainer = document.getElementById('badges-container');
    const newsTitle = document.getElementById('news-title');
    const path = document.getElementById('path');
    const author = document.getElementById('author');
    const postedDate = document.getElementById('posted-date');
    const newsType = document.getElementById('news-type');
    const featuredImageContainer = document.getElementById('featured-image-container');
    const featuredImage = document.getElementById('featured-image');
    const articleAuthor = document.getElementById('article-author');
    const editDeleteBtn = document.getElementById('editDeleteBtn');
    const submitEdit = document.getElementById('submitEdit');
    const commentCards = document.getElementById('commentCards');


    // Show/hide page sections
    function showState(state) {
        loadingState.classList.toggle('hidden', state !== 'loading');
        errorState.classList.toggle('hidden', state !== 'error');
        articleContent.classList.toggle('hidden', state !== 'ready');
    }

    // Get readable category name
    function getCategoryLabel(categoryCode) {
        const categoryMapping = {
            transfer: 'Transfer',
            update: 'Update',
            exclusive: 'Exclusive',
            match: 'Match',
            rumor: 'Rumor',
            analysis: 'Analysis',
        };
        return categoryMapping[categoryCode] || categoryCode;
    }

    // Fetch news data from server
        async function fetchNewsFromServer() {
            try {
                showState('loading');
                
                const response = await fetch(NEWS_DETAIL_ENDPOINT, {
                headers: { 'Accept': 'application/json' },
                });

                if (!response.ok) {
                throw new Error('Failed to fetch news data from server');
                }

                const newsData = await response.json();
                allNewsData = newsData || [];
                
                renderArticle(allNewsData);
                showState('ready');
            } catch (error) {
                console.error('Error loading news:', error);
                showState('error');
            }
        }

    // Render article content
    function renderArticle(news, username) {
        // Set title
        data = news[0].fields;
        newsTitle.textContent = data.title;
        document.title = `${data.title}`;

        pathTitle = data.title;
        if (pathTitle.length > 20) {
            pathTitle = pathTitle.substring(0, 20) + "...";
        }
        
        path.innerHTML = `Home  >  Artikel  >  ${pathTitle}`;

        
        // Set badges
        badgesContainer.innerHTML = '';
        
        // Category badge
        const categoryBadge = document.createElement('span');
        categoryBadge.className = 'inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-green-600 text-white';
        categoryBadge.textContent = getCategoryLabel(data.category);
        badgesContainer.appendChild(categoryBadge);

        const editDeleteButtons = CURRENT_USER_ID && Number(CURRENT_USER_ID) === Number(data.user)
            ? `<div class='flex space-x-2'>
                <button data-id='${news.pk}' class=' editNews button bg-black hover:bg-gray-700 text-white text-sm transition-colors px-4 py-1 rounded'>Edit Artikel</button>
            </div>`
            : '';
        editDeleteBtn.innerHTML = editDeleteButtons;


        let newsId = null;
        function attachEditEventListeners() {
            document.querySelectorAll('.editNews').forEach(button => {
                button.addEventListener('click', async function(event) {
                    event.preventDefault();
                    newsId = news[0].pk;

                    const response = await fetch(`/articles/get-news-ajax/${newsId}`);
                    const article = await response.json();

                    document.getElementById('editTitle').value = article.title;
                    document.getElementById('editContent').value = article.content;
                    document.getElementById('editCategory').value = article.category;
                    document.getElementById('editType').value = article.sports_type;
                    document.getElementById('editThumbnail').value = article.thumbnail;
                    document.getElementById('edit_is_featured').checked = article.is_featured;
                    showEditModal();
                })
            })
        }

        submitEdit.addEventListener('click', async function (event) {
            event.preventDefault();
            if(!newsId) return;
            try{
                const form = document.getElementById('newsEditForm');
                const formData = new FormData(form);
                const response = await fetch(`/articles/edit-news-ajax/${newsId}`, {
                method: 'POST',
                body: formData
                })

                if (response.ok) {
                showToast('News Edited','','success');
                fetchNewsFromServer();
                } else {
                alert('failed to edit news');
                }
            } catch (error) {
                console.error("Error editing news:", error);
                alert("Error editing news.");
            } finally {
                hideEditModal();
                newsId = null;
            }
        })

        attachEditEventListeners();
        
        // Featured badge
        if (data.is_featured) {
            const featuredBadge = document.createElement('span');
            featuredBadge.className = 'inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-yellow-100 text-yellow-800';
            featuredBadge.textContent = 'Featured';
            badgesContainer.appendChild(featuredBadge);
        }
        
        // Popular badge
        if (data.news_views > 20) {
            const popularBadge = document.createElement('span');
            popularBadge.className = 'inline-flex items-center px-3 py-1 rounded-md text-xs font-medium bg-red-100 text-red-800';
            popularBadge.textContent = 'Popular';
            badgesContainer.appendChild(popularBadge);
        }
        
        // Set date and views
        const formattedDate = new Date(data.created_at).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        postedDate.textContent = `    ${formattedDate}`;
        // newsPrice.textContent = `Rp. ${news.price}`;
        
        // Set featured image
        if (data.thumbnail) {
            featuredImage.src = data.thumbnail;
            featuredImage.alt = data.title;
            featuredImageContainer.classList.remove('hidden');
        } else {
            featuredImageContainer.classList.add('hidden');
        }
        
        // Set content
        newsContent.textContent = data.content;
        
        // Set author
        const authorName = username || 'Anonymous';
        author.textContent = `Penulis : ${authorName}`;
    }

    async function getUsername(id) {
        const response = await fetch (`/articles/get-username-by-id/${id}`);
        if (response.ok) {
            const user = await response.json();
            return user.username;
        }
        return "Anonymous";
    } 

    async function getComments(id) {
        const response = await fetch (`/articles/get-comment-by-id/${id}`);
        if (response.ok) {
            const comments = await response.json();
            console.log(comments);
            return comments;
        }
        return;
    }

    // Fetch news detail
    async function loadNewsDetail() {
        try {
            showState('loading');
            
            const response = await fetch(NEWS_DETAIL_ENDPOINT, {
                headers: { 'Accept': 'application/json' },
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch news details');
            }
            
            const newsData = await response.json();
            const username = await getUsername(newsData[0].fields.user);

            renderArticle(newsData, username);
            showState('ready');
        } catch (error) {
            console.error('Error loading news details:', error);
            showState('error');
        }
    }

    function buildCommentCard(comment) {
        const commentElement = document.createElement('comment');
        const username = comment.fields.username;
        const content = comment.fields.content;
        const formattedDate = new Date(comment.fields.created_at).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        // <img or div> 
        // make the profile picture h-10 w-10 there later
        const completeCardHtml = `
            <div class="m-4 p-4 rounded-md border border-1 border-gray-600 hover:shadow-md transition-transform duration-300 hover:-translate-y-1">
                <div flex flex row>
                    <div class="w-full flex flex-row justify-between">
                        <p class="text-lg text-black" mx-3>${username}</p>
                        <p class="text-lg text-gray-600 italic mx-3">${formattedDate}</p>
                    </div>
                    <hr bg-gray-600 border border-0>
                    <p class="text-lg text-black mt-4">${content}</p>
                </div>
            </div>
        `
        commentElement.innerHTML = completeCardHtml;
        return commentElement;
    }

    function renderAllComments(comments) {
        commentCards.innerHTML = '';
        comments.forEach(comment => {
            const commentCard = buildCommentCard(comment);
            commentCards.append(commentCard);
        })
    }

    async function addComment() {
        newsId = NEWS_ID
        await fetch(`/articles/add-comment-ajax/${newsId}`, {
        method: "POST",
        body: new FormData(document.querySelector('#commentForm')),
        })

        document.getElementById("commentForm").reset();
        // hideModal();
            
        // Show toast notification
        showToast('Comment added successfully!', '', 'success');
        // Dispatch custom event to notify main.html about new data
        document.dispatchEvent(new CustomEvent('commentAdded'));

        return false;
    }

    document.getElementById("submitComment").addEventListener("click", function(e) {
        e.preventDefault();
        addComment();
    })

    async function loadComments() {
        try {
            showState('loading');
            const response = await fetch(NEWS_DETAIL_ENDPOINT, {
                headers: { 'Accept': 'application/json' },
            });
            
            if (!response.ok) {
                throw new Error('Failed to fetch news details');
            }
            const newsData = await response.json();
            const comments = await getComments(newsData[0].pk) || [];
            renderAllComments(comments)
            showState('ready');
        } catch (error) {
            console.error('Error loading comments : ', error);
            showState('error');
        }
    }
    
    // document.addEventListener('commentAdded')

    // Initialize page
    loadNewsDetail();
    loadComments();
}
</script>

{% endblock content %}