{% extends 'base.html' %}
{% load static %}
{% block meta %}
<title>{{ title }}</title>
{% endblock meta %}
{% block content %}
<!-- head picture -->
  <div class="bg-cover w-full h-[100px]"
    style="background-image: url('https://png.pngtree.com/thumb_back/fh260/background/20230518/pngtree-red-sports-car-on-the-track-image_2530670.jpg')">
     <div class="bg-white/30 backdrop-blur-sm p-3">
       <div class="absolute inset-0 bg-black opacity-50"></div>
          <div class="relative z-10 flex items-center justify-center h-full">
            <div class="flex items-center justify-center ">
              <div class="w-20 h-20 mx-2">
                <img src="{% static 'image/logo.png' %}" alt="No news available" class="w-full h-full object-contain">
              </div>
              <div class="text-white">
                <p class="text-2xl font-bold">SportZone</p>
                <p>Satu Zona untuk Semua Hal Tentang Olahraga</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    <div>
  </div>
<div class="bg-white w-full h-full p-6">
  <!-- <div class="mt-6 flex flex-row justify-between">
     <div><h1 class="text-yellow-400 text-4xl font-serif" style="font-family: 'Times New Roman', Times, serif;">Latest Articles</h1></div>
     <div class="w-full flex items-center"><hr class="border-2 border-yellow-400 w-full"></div>
  </div> -->



  <!-- erase this later -->
  <div class="flex flex col items-center justify left mb-4">
    <button id="create" class="bg-sky-300 hover:bg-sky-500 px-3 py-2 rounded transition-colors mx-2">Create News</button>
    {% if user.is_authenticated %}
    <a href="{% url 'account:logout' %}"><button id="logout" class="bg-sky-300 hover:bg-sky-500 px-3 py-2 rounded transition-colors mx-4">Logout</button></a>
    <h1>User : {{ username }}</h1>
    {% else %}
    <a href="{% url 'account:login' %}"><button id="login" class="bg-sky-300 hover:bg-sky-500 px-3 py-2 rounded transition-colors mx-2">Login</button></a>
    {% endif %}
  </div>




  <!-- Loading State -->
  <!-- i changed some colors (svg class, circle class stroke, path class fill) here -->
  <div id="loading" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
    <svg class="animate-spin h-8 w-8 text-cyan-500 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="cyan-500" stroke-width="4"></circle>
      <path class="opacity-75" fill="cyan-500" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    <p class="text-gray-600 mt-3">Loading news...</p>
  </div>

  <!-- Error State -->
  <div id="error" class="hidden"></div>

  <!-- News Grid -->
  <div id="grid" class="hidden">
    <!-- artikel trending (featured) -->
    <div class="mb-4">
      <!-- judul -->
      <div class="text-black text-xl font-semibold mb-2"><p>ARTIKEL TRENDING</p></div>

      <!-- divider -->
      <div><hr class="border-black w-full mb-4"></div>

      <!-- cards -->
      <div id="featuredGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
    </div>

    <!-- artikel terbaru -->
    <div class="mb-4">
      <!-- judul -->
      <div class="text-black text-xl font-semibold mb-2"><p>ARTIKEL HOT</p></div>

      <!-- divider -->
      <div><hr class="border-black w-full mb-4"></div>

      <!-- cards -->
      <div id="hotGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
    </div>

    <!-- mungkin anda tertarik -->
    <div class="mb-4">
      <!-- judul -->
      <div class="text-black text-xl font-semibold mb-2"><p>JELAJAHI</p></div>

      <!-- divider -->
      <div><hr class="border-black w-full mb-4"></div>

      <!-- cards -->
      <div id="exploreGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
    </div>
  </div>

  <!-- Empty State -->
  <div id="empty" class="bg-white rounded-lg border border-gray-200 p-12 text-center hidden">
    <div class="w-32 h-32 mx-auto mb-4">
      <img src="{% static 'image/no-news.png' %}" alt="No news available" class="w-full h-full object-contain">
    </div>
    <h3 class="text-lg font-medium text-gray-900 mb-2">No News Yet</h3>
    <p class="text-gray-500 mb-6">Got something to share?</p>
    <a href="{% url 'article:add_news_entry_ajax' %}" class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
      Create News
    </a>
  </div>
</div>

<script>
  const NEWS_API_ENDPOINT = "{% url 'article:show_json' %}";
  const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

  window.onload = function() {
    const loadingSpinner = document.getElementById('loading');
    const errorMessage = document.getElementById('error');
    const emptyStateDisplay = document.getElementById('empty');
    const newsGridContainer = document.getElementById('grid');
    const hotGridContainer = document.getElementById('hotGrid');
    const featuredGridContainer = document.getElementById('featuredGrid');
    const exploreGridContainer = document.getElementById('exploreGrid');
    const showAllNewsButton = document.getElementById('filter-all');
    const showMyNewsButton = document.getElementById('filter-my');
    const showFeaturedButton = document.getElementById('filter-featured');
    const showCatTransferButton = document.getElementById('filter-transfer');
    const showCatUpdateButton = document.getElementById('filter-update');
    const showCatMatchButton = document.getElementById('filter-match');
    const showCatRumorButton = document.getElementById('filter-rumor');
    const showCatExclusiveButton = document.getElementById('filter-exclusive');
    const showCatAnalysisButton = document.getElementById('filter-analysis');
    const refresh = document.getElementById('refresh');
    const confirmDelete = document.getElementById('confirmDelete');
    const submitEdit = document.getElementById('submitEdit');

    // temporaryDOM, erase later
    const logoutBtn = document.getElementById('logout');
    const createBtn = document.getElementById('create');

    // State Variables
    let activeFilter = 'all';
    let allNewsData = [];

    // Show/hide page sections
    function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
      loadingSpinner.classList.toggle('hidden', !showLoading);
      errorMessage.classList.toggle('hidden', !showError);
      emptyStateDisplay.classList.toggle('hidden', !showEmpty);
      newsGridContainer.classList.toggle('hidden', !showGrid);
    }

    // Get readable category name
    function getReadableCategoryName(categoryCode) {
      const categoryMapping = {
        update: 'Update',
        regional: 'Regional',
        global: 'Global',
        antique: 'Antique',
        special: 'Special',
      };
      return categoryMapping[categoryCode] || categoryCode;
    }

    // Create news card element
    function buildNewsCardElement(news) {
      const data = news.fields
      const articleElement = document.createElement('article');
      articleElement.className = 'bg-green-600 border border-gray-200 hover:shadow-lg transition-shadow duration-300 overflow-hidden flex flex-col h-full';

      const detailLink = `{% url 'article:show_detail' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', news.pk);
      const editLink = `{% url 'article:edit_article' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', news.pk);
      const deleteLink = `{% url 'article:delete_article' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', news.pk);

      const title = DOMPurify.sanitize(data.title);
      const description = DOMPurify.sanitize(data.description);
      const category = DOMPurify.sanitize(data.category);
      const type = DOMPurify.sanitize(data.sports_type)
      const thumbnail = DOMPurify.sanitize(data.thumbnail);
      const createdAt = DOMPurify.sanitize(new Date(data.created_at).toLocaleDateString('en-US', { 
          year: 'numeric', 
          month: 'short', 
          day: 'numeric' 
      }));

      const newsViews = DOMPurify.sanitize(data.news_views);
      const isFeatured = data.is_featured;
      const isPopular = newsViews > 20;

      const thumbnailHtml = DOMPurify.sanitize(
            data.thumbnail ? `<img src='${thumbnail}' alt='${title}' class='w-full h-full object-cover'>` : `<div class='w-full h-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center'></div>`
        );
      const categoryLabel = DOMPurify.sanitize(getReadableCategoryName(category));
        const featuredLabel = isFeatured ? DOMPurify.sanitize(`<span class='inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800'>Featured</span>`) : '';
        const popularLabel = isPopular ? DOMPurify.sanitize(`<span class='inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800'>Popular</span>`) : '';

      const editDeleteButtons = CURRENT_USER_ID && Number(CURRENT_USER_ID) === Number(data.user)
        ? `<div class='flex space-x-2'>
            <button data-id='${news.pk}' class=' editNews button bg-white hover:bg-gray-200 text-black text-sm transition-colors px-3 py-2 rounded onclick="showEditModal()"'>Edit</button>
            <button data-id='${news.pk}' class=' deleteNews button bg-red-600 hover:bg-red-700 text-white hover:text-gray-100 text-sm transition-colors px-3 py-2 rounded onclick="showConfirmModal()"'>Delete</button>
          </div>`
        : '';

      const completeCardHtml = `
        <div class="aspect-[8/5] relative overflow-hidden">
          ${thumbnailHtml}
          <div class="absolute top-3 left-3">
            <span class="inline-flex items-center px-2.5 py-0.5 d text-xs font-medium bg-green-600 text-white">${categoryLabel}</span>
          </div>
          <div class="absolute top-3 right-3 flex space-x-2">
            ${featuredLabel}
            ${popularLabel}
          </div>
        </div>
        <div class="p-5 flex flex-col flex-1">
          <div class="flex items-center text-sm text-gray-900 mb-3">
            <span>${type}</span>
            <span class="mx-2"> --••-- </span>
            <time>${createdAt}</time>
          </div>
          <h3 class="text-lg font-semibold text-white mb-3 line-clamp-2 leading-tight">
            <a href="${detailLink}" class="hover:text-yellow-400 transition-colors">${title}</a>
          </h3>
          <p class="text-gray-900 text-sm leading-relaxed line-clamp-3 mb-4">${description}</p>
          <div class="pt-4 border-t border-gray-100 flex items-center justify-between">
            <a href="${detailLink}" class="button bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-medium text-sm transition-colors px-3 py-2 rounded">Read more</a>
            ${editDeleteButtons}
          </div>
        </div>
      `;

      articleElement.innerHTML = completeCardHtml;
      return articleElement;
    }

    // Render all news cards
    function renderAllNewsCards(articles) {
      featuredGridContainer.innerHTML = '';
      hotGridContainer.innerHTML = '';
      exploreGridContainer.innerHTML = '';
      articles.forEach(news => {
        const cardElement = buildNewsCardElement(news);
        if (news.fields.is_featured) {
          featuredGridContainer.appendChild(cardElement);
        } else if (news.fields.is_news_hot()) {
          hotGridContainer.appendChild(cardElement);
        } else {
          exploreGridContainer.appendChild(cardElement);
        }
      });

      attachDeleteEventListeners();
      attachEditEventListeners();
    }

    // Filter and display News
    function filterAndDisplayNews() {
      // updateFilterButtonsAppearance();
      
      const filteredNews = activeFilter === 'all' 
        ? allNewsData 
        : (activeFilter === 'my'
        ? allNewsData.filter(news => Number(news.user_id) === Number(CURRENT_USER_ID))
        : allNewsData.filter(news => news.is_featured === true));
      
      if (filteredNews.length === 0) {
        displayPageSection({ showEmpty: true });
      } else {
        renderAllNewsCards(filteredNews);
        displayPageSection({ showGrid: true });
      }
    }

    // Fetch news data from server
    async function fetchNewsFromServer() {
      try {
        displayPageSection({ showLoading: true });
        
        const response = await fetch(NEWS_API_ENDPOINT, {
          headers: { 'Accept': 'application/json' },
        });

        if (!response.ok) {
          throw new Error('Failed to fetch news data from server');
        }

        const newsData = await response.json();
        allNewsData = newsData || [];
        
        filterAndDisplayNews();
      } catch (error) {
        console.error('Error loading news:', error);
        displayPageSection({ showError: true });
      }
    }


    let newsId = null;
    function attachDeleteEventListeners() {
      document.querySelectorAll('.deleteNews').forEach(button => {
        button.addEventListener('click', async function(event) {
          event.preventDefault();
          newsId = this.getAttribute('data-id');
          showConfirmModal();
        });
      });
    }

    createBtn.addEventListener('click', async function (event) {
      event.preventDefault();
      showModal();
      
    })

    // logoutBtn.addEventListener('click', async function (event) {
    //   event.preventDefault();
    //   console.log("clicked")
    //   const response = await fetch("{% url 'account:logout' %}");
    //   const data = await response.json();
    //   console.log(data.success)
    //   if (data.success == 'Successful logout') {
    //     showToast('logged out successfully!','','success');
    //     setTimeout(() => {
    //       window.location.href = data.redirect;
    //     }, 3000);
    //   } else {
    //     alert("sum ting wong")
    //   }
    // })
  

    confirmDelete.addEventListener('click', async function(event) {
      event.preventDefault();

      if (!newsId) return;
      try {
        const response = await fetch(`/delete-news-ajax/${newsId}/`, {
          method: 'POST'
        });
        
        if (response.ok) {
          // Re-fetch News to refresh the grid
          showToast('News deleted', '', 'error')
          fetchNewsFromServer();
        } else {
          alert("Failed to delete news.");
        }
      } catch (error) {
        console.error("Error deleting news:", error);
        alert("Error deleting news.");
      } finally {
        hideConfirmModal();
        newsId = null;
      }
    })

    function attachEditEventListeners() {
      document.querySelectorAll('.editNews').forEach(button => {
        button.addEventListener('click', async function(event) {
          event.preventDefault();
          newsId = this.getAttribute('data-id');
          console.log(newsId)

          const response = await fetch(`/get-news-ajax/${newsId}`);
          const news = await response.json();

          document.getElementById('editTitle').value = news.title;
          document.getElementById('editContent').value = news.content;
          document.getElementById('editCategory').value = news.category;
          document.getElementById('editType').value = news.sports_type;
          document.getElementById('editThumbnail').value = news.thumbnail;
          document.getElementById('edit_is_featured').checked = news.is_featured;
          showEditModal();
        })
      })
    }

    submitEdit.addEventListener('click', async function (event) {
      event.preventDefault();
      if(!newsId) return;
      try{
        const form = document.getElementById('newsEditForm');
        const formData = new FormData(form);
        const response = await fetch(`/edit-news-ajax/${newsId}`, {
          method: 'POST',
          body: formData
        })

        if (response.ok) {
          showToast('News Edited','','success');
          fetchNewsFromServer();
        } else {
          alert('failed to edit news');
        }
      } catch (error) {
        console.error("Error editing news:", error);
        alert("Error editing news.");
      } finally {
        hideEditModal();
        newsId = null;
      }
    })

    // Event handlers
    function handleShowAllNewsClick() {
      activeFilter = 'all';
      filterAndDisplayNews();
    }

    function handleShowMyNewsClick() {
      activeFilter = 'my';
      filterAndDisplayNews();
    }

    function handleShowFeaturedClick() {
      activeFilter = 'featured';
      filterAndDisplayNews();
    }

    // Add event listener to detect new news
    document.addEventListener('newsAdded', function() {
        // Refresh data without page reload
        fetchNewsFromServer();
    });

    // refresh.addEventListener("click", () => {
    //   fetchNewsFromServer();
    // });

    // Initialize page
    function initializeNewsPage() {
      // showAllNewsButton.addEventListener('click', handleShowAllNewsClick);
      // showMyNewsButton.addEventListener('click', handleShowMyNewsClick);
      // showFeaturedButton.addEventListener('click', handleShowFeaturedClick);
      fetchNewsFromServer();
    }

    // Start application
    initializeNewsPage();
  }
</script>
{% endblock content %}